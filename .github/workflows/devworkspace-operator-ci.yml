name: DevWorkspace Operator CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
env:
  DWO_NAMESPACE_STABLE: devworkspace-controller-stable
  DWO_NAMESPACE_PR: devworkspace-controller-pr
  MEM_THRESHOLD: 0
  CPU_THRESHOLD: 0

jobs:
  test-on-minikube:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Minikube-Kubernetes
        uses: manusa/actions-setup-minikube@v2.14.0
        with:
          minikube version: 'v1.35.0'
          kubernetes version: 'v1.33.0'
          github token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install and Enable Minikube addons metrics-server
        run: |
          minikube addons enable metrics-server
          kubectl rollout status deployment/metrics-server -n kube-system --timeout=300s

      - name: Install and Wait for cert-manager to be ready
        run: |
          kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.18.2/cert-manager.yaml
          kubectl rollout status deployment/cert-manager -n cert-manager --timeout=300s

      - name: Enable and Wait for Ingress addon
        run: |
          minikube addons enable ingress
          kubectl rollout status deployment/ingress-nginx-controller -n ingress-nginx --timeout=300s

      - name: Clone DevWorkspace Operator repo
        run: |
          git clone https://github.com/devfile/devworkspace-operator.git devworkspace-operator
          cd devworkspace-operator
          git checkout main 

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - name: Deploy DevWorkspace Operator (stable)
        run: |
          cd devworkspace-operator
          export DWO_IMG=quay.io/devfile/devworkspace-controller:next
          export NAMESPACE=$DWO_NAMESPACE_STABLE
          make install
          kubectl rollout status deployment/devworkspace-controller-manager -n $DWO_NAMESPACE_STABLE --timeout=300s
          sleep 100
          kubectl top pod --no-headers -n $DWO_NAMESPACE_STABLE $(kubectl get pods -n $DWO_NAMESPACE_STABLE -l app.kubernetes.io/name=devworkspace-controller -o jsonpath='{.items[0].metadata.name}') > /tmp/stable-metrics.txt
          make uninstall

      - name: Build DevWorkspace Operator from PR
        run: |
          cd devworkspace-operator
          export DWO_IMG=ttl.sh/devworkspace-operator:15m
          export NAMESPACE=$DWO_NAMESPACE_PR
          make docker

      - name: Deploy DevWorkspace Operator from PR to Minikube
        run: |
          cd devworkspace-operator
          export DWO_IMG=ttl.sh/devworkspace-operator:15m
          export NAMESPACE=$DWO_NAMESPACE_PR
          make install
          kubectl get pods -n $DWO_NAMESPACE_PR
          kubectl rollout status deployment/devworkspace-controller-manager -n $DWO_NAMESPACE_PR --timeout=300s
          sleep 100
          kubectl get pods -n $DWO_NAMESPACE_PR
          kubectl describe pods -n $DWO_NAMESPACE_PR

      - name: Save DevWorkspace Operator pods metrics
        run: |
          kubectl top pod --no-headers -n $DWO_NAMESPACE_PR $(kubectl get pods -n $DWO_NAMESPACE_PR -l app.kubernetes.io/name=devworkspace-controller -o jsonpath='{.items[0].metadata.name}') > /tmp/pr-metrics.txt
          cat /tmp/pr-metrics.txt
      
      - name: Compare CPU usage
        run: |
          convert_cpu() {
            echo "${1%m}"
          }

          CPU1=$(cat /tmp/stable-metrics.txt | awk '{print $2}')
          CPU2=$(cat /tmp/pr-metrics.txt | awk '{print $2}')

          CPU1_INT=$(convert_cpu $CPU1)
          CPU2_INT=$(convert_cpu $CPU2)

          CPU_DIFF=$(( CPU2_INT - CPU1_INT ))

          echo "CPU stable pod: ${CPU1_INT}m"
          echo "CPU PR pod: ${CPU2_INT}m"
          echo "CPU difference: ${CPU_DIFF}m"

          if (( CPU_DIFF > CPU_THRESHOLD )); then
            echo "❌ CPU usage increased by more than ${CPU_THRESHOLD}m"
            exit 1
          fi
          echo "✅ CPU usage within threshold."

      - name: Compare Memory usage
        run: |
          convert_mem() {
            val=$1
            if [[ $val == *Ki ]]; then
              echo $(( ${val%Ki} / 1024 ))
            elif [[ $val == *Mi ]]; then
              echo ${val%Mi}
            elif [[ $val == *Gi ]]; then
              echo $(( ${val%Gi} * 1024 ))
            else
              echo 0
            fi
          }

          MEM1=$(cat /tmp/stable-metrics.txt | awk '{print $3}')
          MEM2=$(cat /tmp/pr-metrics.txt | awk '{print $3}')

          MEM1_INT=$(convert_mem $MEM1)
          MEM2_INT=$(convert_mem $MEM2)

          MEM_DIFF=$(( MEM2_INT - MEM1_INT ))

          echo "Memory stable pod: ${MEM1_INT}Mi"
          echo "Memory PR pod: ${MEM2_INT}Mi"
          echo "Memory difference: ${MEM_DIFF}Mi"

          if (( MEM_DIFF > MEM_THRESHOLD )); then
            echo "❌ Memory usage increased by more than ${MEM_THRESHOLD}Mi"
            exit 1
          fi
          echo "✅ Memory usage within threshold."
